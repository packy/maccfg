#!/bin/sh

function is_git_dir () {
    [ -d .git ] || [ "$(git rev-parse --is-inside-work-tree 2>/dev/null)" == "true" ]
}

function is_git_p4_dir () {
    is_git_dir && git log -n 10 | grep -q '\[git-p4\:'
}

if is_git_p4_dir; then
    # can remove code to stash once git on P4 machine can be upgraded
    CHANGES=$(git status --short --untracked-files=no)
    if [[ "$CHANGES" != "" ]]; then
        echo Stashing uncommitted changes
        git stash
    fi

    echo "> git p4 rebase $*"
    git p4 rebase $*

    if [[ "$CHANGES" != "" ]]; then
        echo Popping stashed changes
        git stash pop
    fi
else
    echo "> git pull --rebase $*"
    git pull --rebase --autostash $*
fi
